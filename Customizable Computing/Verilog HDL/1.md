# 1 Verilog HDL 可综合描述原则

## 1.1 关于Verilog HDL的认知

* HDL: Hardware Description Language
* HDL仅是对已知硬件电路的文本表现形式的编写前，最所需实现的电路胸有成竹

### 与C语言相比HDL在概念上的显著区别

* 互联：wire型变量描述各个模块之间的端口与网线的连接关系
* 并发：可以有效地描述并行的硬件系统
* 时间：定义了绝对和相对的时间度量，可综合操作符具有物理延迟

## 1.2 Verilog HDL用于可综合描述的语句

### 可综合语句：

* always
* if-else
* case
* assign

### 可综合风格禁止出现：

* function
* for
* fork-join
* while
  
不可综合的关键字一般用于仿真.

### 高性能编写方法

* if-else相关语句的硬件结构映射及优化
  * if-else会被映射为多路选择器
  * 单if语句会生成无优先级的判断结构（推荐使用）
  * 多if语句会生成有优先级的判断结构（会消耗组合逻辑，不推荐使用）
  * 在某些设计中有些信号要求先到达（如使能信号、选择信号），而有些信号需要后到达（慢速信号、有效时间较长的信号），此时需要使用多if语句，将最高优先级给最迟到达的信号
* case相关语句的硬件结构映射及优化
  * 生成无优先级的判断结构
  * 条件互斥，多用于指令译码电路
  * 综合器指令：full-case和parallel-case
    * full-case告诉综合器当前case结构所列条件已经完备（用于所列分支不完备）
    * parallel-case告诉综合器所有条件均互斥且并行，无优先级（用于分支条件不互斥）
* 慎用latch
  * 综合器很难解释latch，除非特殊用途，一般避免引入latch，通常在异步电路或门控时钟中会引入latch
  * latch容易产生毛刺，对下一级电路而言是十分危险的
  * 防止产生latch：
    * 使用完备的if-else语句
    * 为每个输入条件设计输出操作
    * 仔细检查综合器生成的报告，latch会以warning的形式报告
* 逻辑复制
  * 电路设计过程中如果发现某个电路的负载比较多，则可以通过逻辑复制来降低关键信号的扇出，进而降低该信号的传播延迟，提高电路性能
* 逻辑共享
  * 使用资源共享可以减小面积，但一般而言共享会导致性能下降，故要根据性能和面积来进行取舍
* 资源顺序重排
  * 根据数据的延迟，对资源进行顺序的重排，降低传播延迟
* 同步复位与异步复位

## 1.3 可综合风格

* 完整的always敏感信号列表
  * 所有的组合逻辑或锁存的always结构必须有敏感信号列表，这个敏感信号列表必须包含所有的输入信号
  * 原因：综合器在综合过程中将产生一个取决于敏感信号列表外的所有信号的结构，它将可能在行为仿真和门级仿真间产生潜在的失配
* 每个always敏感信号列表对应一个时钟
  * 在综合过程中，每个always敏感信号列表只能对应一个时钟
  * 原因：这是将每一个过程限制在单一寄存器类型的要求
* 不允许wait声明和#delay声明
  * 延迟声明不能用于可综合设计
  * 在不需要进行综合的行为模块中，如测试模块、表示行为的虚拟器件中可以使用
* 在时序电路中必须使用非阻塞赋值（<=）,组合逻辑电路中必须使用阻塞赋值（=）

## 1.4 模块划分

* 分开异步逻辑与同步逻辑
  * 避免综合时的问题，简化约束和编码难度
  * 在非综合模块中，可以不这样来写
* 分开控制逻辑和存储器
  * 建议控制逻辑和存储器逻辑分成独立的模块
  * 便于高层的存储器模块的使用和便于重新描述为不同的存储器类型
  * 存储器一般用memory compiler生成，综合方式与RTL代码不同，混合后不利于综合，且不利于很方便地更换工艺库和平台

The quality of optimization results depends on how the HDL description is written. Don't rely on DC for timing!


# 2 RTL在书写中如何考虑延迟面积等

## 2.1 在RTL代码中考虑延迟

* 在有多级mux的电路中，将延迟最大的信号放在最后一级mux（离输出最近）上，但要保证原电路功能不变
* 对于控制信号延迟大的情况，采用增加数据通道的方法来降低延迟（将 先选后加 改为 先加后选）
* 对于将运算结果进行比较的情况，如果有数据延迟，可应用如下策略：将A+B<24改为A<24-B 

## 2.2 在RTL代码中考虑面积

* 随着芯片工艺的进步和生产成本的降低，面积问题显得没有时序问题重要。但减小设计的面积意味着成本降低、功耗降低，特备是对FPGA的设计，直接决定着FPGA的选型
* 一般综合过程中可以对面积进行优化，但在RTL编码中如果注意节约设计的面积，往往可以达到事半功倍的效果
* 减少设计面积应注意估计设计使用资源的数量（触发器、加法器、乘法器等），可以借助一些工具来完成，最终应该知道设计中哪些部分占用了较大的面积，进而分析改进的方法。
* 一般来说，触发器的数量由功能决定，很难减少，同时其面积也比较好估计
* 组合逻辑部分是面积优化的重点，对应至RTL代码便是各种操作符，如常见的 + - * / 比较运算符等都可能产生较大面积的组合逻辑
  * 对于以上操作应先判断其必要性，是否能用更简单的运算来代替
  * 如果必须使用复杂的运算符，则应考虑是否可以资源共享。尽管电路逻辑综合工具也会在综合过程中采用资源共享的方法进行优化，但是，综合器的策略是有限的，因此，在编写RTL的时候，应该尽量考虑共享，而不是把这项工作完全留给综合工具
* 多比特的信号会成倍使用资源，因此应该注意一个信号的所有比特是否都需要参与操作，如果不是，则可以只对需要的部分比特进行操作
* 总之，针对不同的设计有各种各样优化和改进的方法，因此在编写代码时应对操作符有足够的重视，对有可能简化的地方尽量简化。逻辑简化在减少面积的同时也减少了延迟，是值得花费一些时间的。

## 2.3 在RTL编码中考虑功耗

* 由电路动态功耗的计算公式，电路的动态功耗由该点的翻转次数、电路的工作频率、该点的电容以及电压值来决定
* 就RTL设计而言，负载电容和工作电压都是无法改变的因素，因此在RTL级主要考虑尽可能降低电路的翻转频率，主要措施包括如下：
  * 门控时钟
  * 增加使能信号，使得部分电路只有在需要工作时才工作
  * 对芯片各个模块进行控制，在需要工作时才工作
  * 除了有用信号和时钟的翻转会消耗功耗，组合逻辑产生的毛刺也会消耗大量功耗。但是，毛刺在设计中无法避免，因此，只有尽量减少毛刺在电路中的传播，才可以减少功耗。即，在设计中尽量把产生毛刺的电路放在传播路径的最后另外，可以使用一些减少毛刺的技术。
  * 对有限状态机，可以采用低功耗编码来减少电路的翻转，如 0101 -> 1010 可改为 0101 -> 0100 来降低功耗

总之：
* 首先应考虑全局的功耗控制
* 在RTL编码中，注意消耗功率比较多的电路，如状态机、译码器、多路选择器等
* 在综合中，使用门控时钟和其他减少功耗的优化技术

使用门控时钟和采用使能信号的区别：
* 增加使能仅仅是使得电路中的信号不在翻转，而时钟还是会翻转的；而使用门控时钟则会直接关掉整个时钟，效果更好。

## 2.4 在RTL编码中考虑布线问题

在芯片设计的流程中，布线（Routing）是最后的阶段，是根据门级网表的描述，实现各个单元的连接；布线成功与否的关进因素在于布局（Placement）
但即使使用最好的布线工具，还是出现无法布通的情况；在这种情况下，则需要修改RTL级设计来解决。

* 热点，指设计的功能需要在一个面积内占用大量的布线资源
* 热点产生的原因：在RTL编码中使用了特定结构，如很大的MUX
* 上述结构产生的热点，在综合阶段，延迟是看不出来的，只有在布线阶段才能看到其负面影响。因此，我们在RTL阶段应重视这种电路，及早发现可能在布线阶段产生的问题
* 如果设计中确实需要采用较大的MUX，可以通过其他方法来改变其结构，基本思路是将一个大的MUX分解为多级较小的MUX


# 3 RTL设计指导原则 